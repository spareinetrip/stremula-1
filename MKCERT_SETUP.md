# mkcert Setup Guide

This guide explains how to set up mkcert for trusted local SSL certificates.

## What is mkcert?

mkcert is a simple tool for making locally-trusted development certificates. It automatically creates and installs a local CA in your system's trust store, so certificates generated by mkcert are automatically trusted by browsers and applications.

## Installation

### macOS

```bash
brew install mkcert
```

### Linux (Raspberry Pi / Debian/Ubuntu)

```bash
# Install certutil (required dependency)
sudo apt install libnss3-tools

# Install mkcert
# Option 1: Using pre-built binary
wget -O mkcert https://github.com/FiloSottile/mkcert/releases/latest/download/mkcert-v1.4.4-linux-amd64
chmod +x mkcert
sudo mv mkcert /usr/local/bin/

# Option 2: Build from source (if above doesn't work)
# Requires Go: sudo apt install golang-go
# go install filippo.io/mkcert@latest
```

### Windows

```bash
# Using Chocolatey
choco install mkcert

# Or using Scoop
scoop bucket add extras
scoop install mkcert
```

## One-Time Setup

After installing mkcert, you need to install the local CA (Certificate Authority) on your system:

```bash
mkcert -install
```

This will:
- Create a local CA certificate
- Install it in your system's trust store
- Make all certificates generated by mkcert automatically trusted

**Note:** You only need to run this once per machine.

## How Stremula Uses mkcert

When you start the Stremula server:

1. It checks if mkcert is installed
2. If the CA is not installed, it will attempt to install it automatically
3. It generates a certificate for all your local IPs and hostnames
4. The certificate is automatically trusted by your browser

## Installing CA on Other Devices

To use Stremula from other devices (like your iPhone, iPad, or Apple TV), you need to install the mkcert CA certificate on those devices.

### Finding the CA Certificate

The CA certificate is located at:

- **macOS:** `~/Library/Application Support/mkcert/rootCA.pem`
- **Linux:** `~/.local/share/mkcert/rootCA.pem`
- **Windows:** `%LOCALAPPDATA%\mkcert\rootCA.pem`

Or download it from your server: `https://YOUR_SERVER_IP:7004/ca.crt`

### Installing on macOS

1. Copy `rootCA.pem` to your Mac
2. Double-click the file
3. Keychain Access will open
4. Find "mkcert" in the login keychain
5. Double-click it
6. Expand "Trust" section
7. Set "When using this certificate" to "Always Trust"
8. Enter your password

### Installing on iOS

**Option 1: Via Email/Web**
1. Email the `rootCA.pem` file to yourself
2. Open the email on your iOS device
3. Tap the attachment
4. Go to **Settings → General → About → Certificate Trust Settings**
5. Enable trust for "mkcert root certificate authority"

**Option 2: Via Configuration Profile**
1. Create a `.mobileconfig` file (see template below)
2. Host it on a web server or email it
3. Open on iOS device
4. Install the profile

### Installing on tvOS

tvOS requires Apple Configurator 2:
1. Use Apple Configurator 2 to create a configuration profile
2. Add the CA certificate to the profile
3. Install the profile on your Apple TV

## Configuration Profile Template for iOS/tvOS

Create a file named `mkcert-ca.mobileconfig`:

```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
    <key>PayloadContent</key>
    <array>
        <dict>
            <key>PayloadType</key>
            <string>com.apple.security.root</string>
            <key>PayloadUUID</key>
            <string>UNIQUE-UUID-HERE</string>
            <key>PayloadIdentifier</key>
            <string>com.mkcert.rootca</string>
            <key>PayloadVersion</key>
            <integer>1</integer>
            <key>PayloadDisplayName</key>
            <string>mkcert Root CA</string>
            <key>PayloadDescription</key>
            <string>Root CA certificate for mkcert</string>
            <key>PayloadCertificateFileName</key>
            <string>rootCA.pem</string>
            <key>PayloadContent</key>
            <data>
            <!-- Base64 encoded rootCA.pem content goes here -->
            </data>
        </dict>
    </array>
    <key>PayloadDisplayName</key>
    <string>mkcert CA Certificate</string>
    <key>PayloadIdentifier</key>
    <string>com.mkcert.certificate</string>
    <key>PayloadRemovalDisallowed</key>
    <false/>
    <key>PayloadType</key>
    <string>Configuration</string>
    <key>PayloadUUID</key>
    <string>UNIQUE-UUID-HERE</string>
    <key>PayloadVersion</key>
    <integer>1</integer>
</dict>
</plist>
```

To get the Base64 content:
```bash
base64 -i rootCA.pem | tr -d '\n'
```

## Verification

After setup:

1. **Check mkcert is installed:**
   ```bash
   mkcert -version
   ```

2. **Check CA is installed:**
   ```bash
   mkcert -CAROOT
   ```

3. **Test certificate generation:**
   ```bash
   mkcert localhost 127.0.0.1 ::1
   ```

4. **Verify in browser:**
   - Visit `https://localhost:7004/manifest.json`
   - Should load without warnings (green padlock)

## Troubleshooting

### "mkcert: command not found"
- Make sure mkcert is installed and in your PATH
- Try: `which mkcert` to find its location

### "Permission denied" on Linux
- Make sure you have write access to `~/.local/share/mkcert`
- Or run with appropriate permissions

### Certificate still shows warnings
- Clear browser cache
- Make sure CA is installed: `mkcert -install`
- Restart browser
- On iOS: Check Certificate Trust Settings

### iOS won't trust the certificate
- iOS 13+ requires manual trust in Settings → General → About → Certificate Trust Settings
- Make sure you're using the correct CA certificate

## Benefits of mkcert

✅ **Automatic trust** - No manual certificate installation needed (on the same machine)  
✅ **Simple setup** - One command to install CA  
✅ **Works everywhere** - Supports all IPs, hostnames, and localhost  
✅ **No warnings** - Browsers trust certificates automatically  
✅ **Easy regeneration** - Just run mkcert again with new IPs  

## Security Note

⚠️ **Important:** The mkcert CA certificate should only be installed on devices you trust. Anyone with access to the CA can create trusted certificates for any domain/IP.

